# Database Migrations

Database migration is the process of making a set of changes to a database schema or data in a *controlled* and *automated* manner. This normally involves using scripts to apply changes to the database, to ensure consistency and reliability across different environments.

**Why?**

Well, manually updating a database schema or data across multiple environments can lead to inconsistencies, where certain changes are applied in one environment but not in others. Sometimes people will make changes locally directly to their database to fix something, but forget to code the fix - so you end up with it working in one place, but when you try to stand up another environment it falls over...

## Postgres Install

We're going to be using PostgreSQL as our database. If you don't have it installed already, check out [this guide](https://www.postgresqltutorial.com/postgresql-getting-started/install-postgresql/) on how to install it. MMake sure you install `pgAdmin`, `PostgreSQL Server` and `Command Line Tools`.

Please make a note of the password you set in the setup!

## Create the DB

Now we have that done, we need to create a new DB to connect to. Open a new terminal and type

`psql -U postgres`

Enter your password when you setup PostgreSQL. You should now be in the `psql` shell. You can tell as your terminal prompt should look like:

`postgres-#`

Next we need to create the `test_migrations` database. Type in the following command:

`create database test_migrations;`

Now type `\q` to exist the psql command line.

## Go Install

This guide assumes you have the latest version of Go installed. If you don't have it yet [download from here](https://go.dev/doc/install).

## Goose Install

We need to install [goose](https://github.com/pressly/goose), which will manage and apply our migrations. From a terminal run:

`go install github.com/pressly/goose/v3/cmd/goose@latest`

## Project Setup

Create a new folder named "migrations" and open the folder in VS Code.

## Your First Migration

> :exclamation: NOTE: Where you see `YOURPASSWORD` in a string, you will need to replace that with your postgres user password before running the command!!!

Now we are going to create a SQL migration file. Run the following command in the terminal:

`goose postgres "user=postgres password=YOURPASSWORD dbname=test_migrations sslmode=disable" create first_migration sql`

**Output**
`2024/05/10 07:56:44 Created new file: 20240510065644_first_migration.sql`

This creates a new file (your filename will be slightly different) based on the current date and time.

### What did that command do?

As per the documents, the format is `Usage: goose [OPTIONS] DRIVER DBSTRING COMMAND`.

- `goose` is the name of the executable
- `[OPTIONS]` are optional, we haven't provided any
- `DRIVER` we have chosen `postgres`, as we want to connect to a postgres DB
- `DBSTRING` we provided our connection string to the DB
- `COMMAND` which uses the format `create NAME [sql|go]` creates new migration file with the current timestamp. We have elected to create a new migration file, with the name `first_migration` as a `.sql` file.

### Inside our migration

If you open up your `.sql` file that was created, you should see the following:

```sql
-- +goose Up
-- +goose StatementBegin
SELECT 'up SQL query';
-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin
SELECT 'down SQL query';
-- +goose StatementEnd
```

This file contains two sections, one  named "up" for the changes we want to apply, and one named "down" for teardown instructions. The "down" section is optional.

- Up : the changes we want to apply
- Down : how to remove the changes in Up section!

### Create a table

Replace the line `SELECT 'up SQL query';` with:

```sql
CREATE TABLE Users (
    id bigint primary key generated by default as identity,
    name VARCHAR(50)
);
```

Now replace the `SELECT 'down SQL query';` with:

```sql
DROP TABLE Users;
```

Save the file!

## Running your first migration

Now, on the terminal we want to apply our migration. Run the following command:

`goose postgres "user=postgres password=YOURPASSWORD dbname=test_migrations sslmode=disable" up`

**Output**
```
2024/05/10 08:22:21 OK   20240510065644_first_migration.sql (7.03ms)
2024/05/10 08:22:21 goose: successfully migrated database to version: 20240510065644
```

## Set Environment Variables

Having to type in the connection string each time is a bit annoying isn't it? 

We can use *environment variables* to store this information for us. Instead of hardcoding these details into our code, we can use environment variables, which makes our programs more flexible (and secure, because the connection string isn't in the code!). 

They're handy for configuring applications without needing to change the code itself, and they're especially useful when you're running our code in different environments.

Goose, by default, looks for environment variables `GOOSE_DRIVER` and `GOOSE_DBSTRING` if you don't provide the arguments, so we can set these ourselves.

### Windows

```
set GOOSE_DRIVER=postgres
set GOOSE_DBSTRING=user=postgres password=YOURPASSWORD dbname=test_migrations sslmode=disable
```

### Unix

```
export GOOSE_DRIVER=postgres
export GOOSE_DBSTRING=user=postgres password=YOURPASSWORD dbname=test_migrations sslmode=disable
```

---

Now you can just run `goose up` from the terminal, and `goose create my_migration_name sql` to create new migrations.

Let's remove the migration by running `goose down`:

**Output**
```
2024/05/10 08:38:16 OK   20240510065644_first_migration.sql (13.58ms)
```

> It's okay, when we next run `goose up` our migration will run first and create the Users table for us!

---

## Tasks

1. Create a new migration to add a new column `email` to the Users table - be sure you have the down code to remove the column too!
2. Create a new migration to create a table `Orders` with the fields `id` and `total`, which is a *decimal*.
3. Create a migration that creates a link table `UserOrders` on a one-to-many relationship: one user may have many orders. 

